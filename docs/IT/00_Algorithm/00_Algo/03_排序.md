# TimSort

python、Java 的默认排序算法。

设计基于现实世界中，序列大概率是部分有序的，有序的部分称作*run*。算法遍历数据，把他们放在许多 run 中，同时把这些 run 放在一个栈里。当栈顶的 run 符合 [[03_排序#TimSort#Merge 标准 |Merge 标准]] 时，他们会归并。这样直到遍历完全部的数据，且所有的 runs 都归并成为一个时，排序结束。 

run 有一个最小限制 minrun，序列小于这个长度时会用二分插入排序把这个 run 补足到 minrun。

### Merge 标准

为了维持归并时的平衡，栈顶的三个 run：X，Y，Z 应满足：

1. |Z| > |X| + |Y|
2. |Y| > |X|

不满足任意条件时，Y 就会与 X，Z 中小的那一个归并。

### Merge 空间开销

![[tim-sort-merge-space-overhead]]

如 X，Y 进行归并。首先使用二分查找找到 Y 的第1个元素在 X 中的位置 x_y1，再用二分查找找到 X 中最后一个元素在 Y 中的位置 y_xn。X 在 x_y1 之前的元素和 Y 在 y_xn 之后的元素都是排好序在最终位置得了。接着将两序列剩余部分较短的拷贝到临时空间中，如 X 剩余较短，则从前向后归并，反之从后向前归并。

### Galloping 模式

### 降序 runs

对于严格递减的序列，可以直接翻转。

### 最小 run 长度， minrun

保持在 (32, 64] 之间的长度插入排序效率最好。如果纯按 minrun 划分，划分出来的数量最好是 2 的 n 次幂或略小。

